<!DOCTYPE html>
<html lang="en">
    <head>
        {{> head}}  {{!-- chỉ lấy thư viện head từ main --}}
    </head>
    <!--begin::Body-->
    <body  id="kt_body"  class="app-blank bgi-size-cover bgi-attachment-fixed bgi-position-center" >
        <!--begin::Root-->
        <div class="d-flex flex-column flex-root" id="kt_app_root">
            <!--begin::Page bg image-->
            <style>
                body {
                background-image: url('https://preview.keenthemes.com/metronic8/demo38/assets/media/auth/bg10.jpeg');
                }
                [data-bs-theme="dark"] body {
                background-image: url('https://preview.keenthemes.com/metronic8/demo38/assets/media/auth/bg10-dark.jpeg');
                }
            </style>
            <!--end::Page bg image-->
            <!--begin::Authentication - Sign-in -->
            <div class="d-flex flex-column flex-lg-row flex-column-fluid">
                <!--begin::Aside-->
                <div class="d-flex flex-lg-row-fluid">
                    <!--begin::Content-->
                    <div class="d-flex flex-column flex-center pb-0 pb-lg-10 p-10 w-100">
                        <!--begin::Image-->                
                        <img class="theme-light-show mx-auto mw-100 w-150px w-lg-300px mb-10 mb-lg-20" src="https://preview.keenthemes.com/metronic8/demo38/assets/media/auth/agency.png" alt=""/>    
                        <img class="theme-dark-show mx-auto mw-100 w-150px w-lg-300px mb-10 mb-lg-20" src="https://preview.keenthemes.com/metronic8/demo38/assets/media/auth/agency-dark.png" alt=""/>                 
                        <!--end::Image-->
                        <!--begin::Title-->
                        <h1 class="text-gray-800 fs-2qx fw-bold text-center mb-7"> 
                            Fast, Efficient and Productive
                        </h1>
                        <!--end::Title-->
                        <!--begin::Text-->
                        <div class="text-gray-600 fs-base text-center fw-semibold">
                            In this kind of post, <a href="#" class="opacity-75-hover text-primary me-1">the blogger</a> 
                            introduces a person they’ve interviewed <br/> and provides some background information about 
                            <a href="#" class="opacity-75-hover text-primary me-1">the interviewee</a> 
                            and their <br/> work following this is a transcript of the interview.  
                        </div>
                        <!--end::Text-->
                    </div>
                    <!--end::Content-->
                </div>
                <!--begin::Aside-->
                <!--begin::Body-->
                <div class="d-flex flex-column-fluid flex-lg-row-auto justify-content-center justify-content-lg-end p-12">
                    <!--begin::Wrapper-->
                    <div class="bg-body d-flex flex-column flex-center rounded-4 w-md-600px p-10">
                        <!--begin::Content-->
                        <div class="d-flex flex-center flex-column align-items-stretch h-lg-100 w-md-400px">
                            <!--begin::Wrapper: Nhập Email (Bước 1)-->
                            <div class="d-flex flex-center flex-column flex-column-fluid pb-15 pb-lg-20" id="wrapper_email_check">
                                <!--begin::Form-->
                                <form class="form w-100" novalidate="novalidate" id="form_email_check" action="#">
                                    <!--begin::Heading-->
                                    <div class="text-center mb-10">
                                        <h1 class="text-gray-900 fw-bolder mb-3">Forgot Password?</h1>
                                        <div class="text-gray-500 fw-semibold fs-6">
                                            Enter your email to reset your password.
                                        </div>
                                    </div>
                                    <!--end::Heading-->
                                    <!--begin::Input group-->
                                    <div class="form-floating fv-row mb-8">
                                        <input type="email" class="form-control bg-transparent" name="email" id="input_email" autocomplete="off" placeholder="Enter your email" required/>
                                        <label class="text-muted fw-bold" for="input_email">Enter your email</label>
                                    </div>
                                    <!--end::Input group-->   
                                    <!--begin::Actions-->
                                    <div class="d-flex flex-wrap justify-content-center pb-lg-0">
                                        <button type="button" id="btn_email_check_submit" class="btn btn-primary me-4">
                                        <span class="indicator-label">Submit</span>
                                        <span class="indicator-progress">
                                        Please wait... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                        </span>
                                        </button>
                                        <a href="/auth/login" class="btn btn-light">Cancel</a>
                                    </div>
                                    <!--end::Actions-->
                                </form>
                                <!--end::Form-->
                            </div>
                            <!--end::Wrapper: Nhập Email-->
                            <!--begin::Wrapper: Nhập mã OTP-->
                            <div class="d-flex flex-center flex-column flex-column-fluid pb-15 pb-lg-20 d-none" id="wrapper_send_email">
                                <!--begin::Form-->
                                <form class="form w-100 mb-13" novalidate="novalidate" id="form_otp_verify">
                                    <!--begin::Icon-->
                                    <div class="text-center mb-10">
                                        <img alt="Logo" class="mh-125px" src="https://preview.keenthemes.com/metronic8/demo38/assets/media/svg/misc/smartphone-2.svg" />
                                    </div>
                                    <!--end::Icon-->
                                    <!--begin::Heading-->
                                    <div class="text-center mb-10">
                                        <h1 class="text-gray-900 mb-3">OTP Verification</h1>
                                        <div class="text-muted fw-semibold fs-5 mb-5">
                                            We sent a 6-digit code to your email:
                                        </div>
                                        <div class="fw-bold text-gray-900 fs-3" id="otp_email_display">******@gmail.com</div>
                                    </div>
                                    <!--end::Heading-->
                                    <!--begin::OTP Inputs-->
                                    <div class="mb-10">
                                        <div class="fw-bold text-start text-gray-900 fs-6 mb-1 ms-1">
                                            Enter your 6-digit code
                                        </div>
                                        <div class="d-flex flex-wrap flex-stack" bis_skin_checked="1">
                                          <input type="text" name="code_1" data-inputmask="'mask': '9', 'placeholder': ''" maxlength="1" class="form-control bg-transparent h-60px w-60px fs-2qx text-center mx-1 my-2" value="" inputmode="text">
                                          <input type="text" name="code_2" data-inputmask="'mask': '9', 'placeholder': ''" maxlength="1" class="form-control bg-transparent h-60px w-60px fs-2qx text-center mx-1 my-2" value="" inputmode="text">
                                          <input type="text" name="code_3" data-inputmask="'mask': '9', 'placeholder': ''" maxlength="1" class="form-control bg-transparent h-60px w-60px fs-2qx text-center mx-1 my-2" value="" inputmode="text"> 
                                          <input type="text" name="code_4" data-inputmask="'mask': '9', 'placeholder': ''" maxlength="1" class="form-control bg-transparent h-60px w-60px fs-2qx text-center mx-1 my-2" value="" inputmode="text"> 
                                          <input type="text" name="code_5" data-inputmask="'mask': '9', 'placeholder': ''" maxlength="1" class="form-control bg-transparent h-60px w-60px fs-2qx text-center mx-1 my-2" value="" inputmode="text">                     
                                          <input type="text" name="code_6" data-inputmask="'mask': '9', 'placeholder': ''" maxlength="1" class="form-control bg-transparent h-60px w-60px fs-2qx text-center mx-1 my-2" value="" inputmode="text"> 
                                       </div>
                                    </div>
                                    <!--end::OTP Inputs-->
                                    <!--begin::Submit-->
                                    <div class="d-flex flex-center">
                                        <button type="button" id="btn_verify_otp" class="btn btn-lg btn-primary fw-bold">
                                        <span class="indicator-label">Verify</span>
                                        <span class="indicator-progress">
                                        Please wait... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                        </span>
                                        </button>
                                    </div>
                                    <!--end::Submit-->
                                </form>
                                <!--end::Form-->
                                <!--begin::Notice-->
                                <div class="text-center fw-semibold fs-5 mt-5">
                                    <span class="text-muted me-1">Didn't get the code?</span>
                                    <a href="#" id="btn_resend_otp" class="link-primary fs-5 me-1">Resend</a>
                                    <span class="text-muted me-1">or</span>
                                    <a href="#" class="link-primary fs-5">Contact Support</a>
                                </div>
                                <!--end::Notice-->
                            </div>
                            <!--end::Wrapper-->
                            <!--begin::Wrapper: Đặt lại mật khẩu mới-->
                            <div class="d-flex flex-center flex-column flex-column-fluid pb-15 pb-lg-20 d-none" id="wrapper_password_reset">
                                <!--begin::Form-->
                                <form class="form w-100" novalidate="novalidate" id="form_password_reset" action="#">
                                    <!--begin::Heading-->
                                    <div class="text-center mb-10">
                                        <h1 class="text-gray-900 fw-bolder mb-3">Setup New Password</h1>
                                    </div>
                                    <!--end::Heading-->
                                    <!--begin::Thông báo email-->
                                    <div id="password_reset_email_notice" class="text-center text-gray-500 fst-italic fs-6 mb-6">
                                        <!-- Nội dung sẽ được gán bằng JS -->
                                    </div>
                                    <!--end::Thông báo email-->
                                    <!--begin::Input: Mật khẩu mới-->
                                    <div class="fv-row mb-8" data-kt-password-meter="true">
                                        <div class="mb-1">
                                            <div class="position-relative mb-3">
                                                <input class="form-control bg-transparent" type="password" placeholder="New Password" name="password" id="input_new_password" autocomplete="off" />
                                                <span class="btn btn-sm btn-icon position-absolute translate-middle top-50 end-0 me-n2" data-kt-password-meter-control="visibility">
                                                <i class="ki-outline ki-eye-slash fs-2"></i>
                                                <i class="ki-outline ki-eye fs-2 d-none"></i>
                                                </span>
                                            </div>
                                            <div class="d-flex align-items-center mb-3" data-kt-password-meter-control="highlight">
                                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px"></div>
                                            </div>
                                        </div>
                                        <div class="text-muted">
                                            Use 8 or more characters with a mix of letters, numbers & symbols.
                                        </div>
                                    </div>
                                    <!--end::Input-->
                                    <!--begin::Input: Nhập lại mật khẩu-->
                                    <div class="fv-row mb-8">
                                        <input type="password" placeholder="Repeat Password" name="confirmPassword" id="input_confirm_password" autocomplete="off" class="form-control bg-transparent" />
                                    </div>
                                    <!--end::Input-->
                                    <!--begin::Checkbox điều khoản-->
                                    <div class="fv-row mb-8">
                                        <label class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="checkbox_terms" value="1" />
                                        <span class="form-check-label fw-semibold text-gray-700 fs-6 ms-1">
                                        I Agree to the <a href="#" class="ms-1 link-primary">Terms and conditions</a>.
                                        </span>
                                        </label>
                                    </div>
                                    <!--end::Checkbox-->
                                    <!--begin::Submit-->
                                    <div class="d-grid mb-10">
                                        <button type="button" id="btn_password_reset_submit" class="btn btn-primary">
                                        <span class="indicator-label">Submit</span>
                                        <span class="indicator-progress">
                                        Please wait... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                        </span>
                                        </button>
                                    </div>
                                    <!--end::Submit-->
                                </form>
                                <!--end::Form-->
                                <!--begin::Heading-->
                                <div class="text-center mb-10">
                                    <div class="text-gray-500 fw-semibold fs-6">
                                        Already reset your password?
                                        <a href="/auth/login" class="link-primary fw-bold">Sign in</a>
                                    </div>
                                </div>
                                <!--end::Heading-->
                            </div>

                           <script>
                              document.addEventListener("DOMContentLoaded", function () {
                                 // BƯỚC 1: Gửi mã xác thực email
                                 const wrapperEmail = document.getElementById("wrapper_email_check");
                                 const wrapperOTP = document.getElementById("wrapper_send_email");
                                 const formEmail = document.getElementById("form_email_check");
                                 const btnEmailSubmit = document.getElementById("btn_email_check_submit");

                                 // BƯỚC 2: Xác minh OTP
                                 const otpWrapper = document.getElementById("wrapper_send_email");
                                 const otpForm = document.getElementById("form_otp_verify"); 
                                 const otpInputs = document.querySelectorAll('#form_otp_verify input[type="text"]');
                                 const otpButton = document.getElementById("btn_verify_otp");

                                 // BƯỚC 3: Đặt lại mật khẩu
                                 const wrapperPassword = document.getElementById("wrapper_password_reset");
                                 const formPassword = document.getElementById("form_password_reset");
                                 const btnPasswordSubmit = document.getElementById("btn_password_reset_submit");

                                 // Biến lưu email hiện tại
                                 window.currentEmail = "";

                                 function isValidEmail(email) {
                                       const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                       return regex.test(email);
                                 }

                                 // ===== BƯỚC 1: Gửi mã xác thực qua email =====
                                 btnEmailSubmit.addEventListener("click", async function () {
                                       const email = document.getElementById("input_email").value.trim();

                                       if (!email) {
                                          return Swal.fire({ icon: "warning", title: "Thiếu email", text: "Vui lòng nhập email của bạn." });
                                       }

                                       if (!isValidEmail(email)) {
                                          return Swal.fire({ icon: "error", title: "Email không hợp lệ", text: "Vui lòng nhập đúng định dạng email." });
                                       }

                                       btnEmailSubmit.disabled = true;
                                       btnEmailSubmit.querySelector(".indicator-label").style.display = "none";
                                       btnEmailSubmit.querySelector(".indicator-progress").style.display = "inline-block";

                                       try {
                                          const res = await fetch("/api/auth/forgot-password/send-code", {
                                             method: "POST",
                                             headers: { "Content-Type": "application/json" },
                                             body: JSON.stringify({ email })
                                          });

                                          const data = await res.json();

                                          btnEmailSubmit.disabled = false;
                                          btnEmailSubmit.querySelector(".indicator-label").style.display = "inline-block";
                                          btnEmailSubmit.querySelector(".indicator-progress").style.display = "none";

                                          if (res.ok) {
                                             window.currentEmail = email;

                                             const [prefix, domain] = email.split("@");
                                             const visible = prefix.slice(0, 5);
                                             const hidden = "*".repeat(Math.max(0, prefix.length - 5));
                                             const obfuscatedEmail = `${visible}${hidden}@${domain}`;

                                             document.querySelector("#wrapper_send_email .fw-bold.text-gray-900.fs-3").innerText = obfuscatedEmail;

                                             wrapperEmail.classList.add("d-none");
                                             wrapperOTP.classList.remove("d-none");
                                          } else {
                                             Swal.fire({ icon: "error", title: "Gửi mã thất bại", text: data.error || "Không thể gửi mã xác nhận. Vui lòng thử lại." });
                                          }
                                       } catch (err) {
                                          btnEmailSubmit.disabled = false;
                                          btnEmailSubmit.querySelector(".indicator-label").style.display = "inline-block";
                                          btnEmailSubmit.querySelector(".indicator-progress").style.display = "none";

                                          Swal.fire({ icon: "error", title: "Lỗi máy chủ", text: "Không thể kết nối đến máy chủ. Vui lòng thử lại sau." });
                                       }
                                 });

                                 // ===== BƯỚC 2: Nhập và xác minh OTP =====
                                 otpInputs.forEach((input, index) => {
                                       input.addEventListener("input", () => {
                                          if (input.value.length === 1 && index < otpInputs.length - 1) {
                                             otpInputs[index + 1].focus();
                                          }
                                       });
                                 });

                                 otpButton.addEventListener("click", async () => {
                                       const code = Array.from(otpInputs).map(i => i.value).join("").trim();

                                       if (code.length !== 6) {
                                          return Swal.fire({ icon: "warning", title: "Thiếu mã OTP", text: "Vui lòng nhập đủ 6 chữ số." });
                                       }

                                       otpButton.disabled = true;
                                       otpButton.querySelector(".indicator-label").style.display = "none";
                                       otpButton.querySelector(".indicator-progress").style.display = "inline-block";

                                       try {
                                          const res = await fetch("/api/auth/forgot-password/verify-code", {
                                             method: "POST",
                                             headers: { "Content-Type": "application/json" },
                                             body: JSON.stringify({
                                                   email: window.currentEmail,
                                                   code: code
                                             })
                                          });

                                          const data = await res.json();

                                          otpButton.disabled = false;
                                          otpButton.querySelector(".indicator-label").style.display = "inline-block";
                                          otpButton.querySelector(".indicator-progress").style.display = "none";

                                          if (res.ok) {
                                             window.recoveryCode = code;
                                             Swal.fire({
                                                   icon: "success",
                                                   title: "Xác minh thành công",
                                                   timer: 1500,
                                                   showConfirmButton: false
                                             }).then(() => {
                                                   wrapperOTP.classList.add("d-none");
                                                   wrapperPassword.classList.remove("d-none");

                                                   if (window.currentEmail) {
                                                      const [prefix, domain] = window.currentEmail.split("@");
                                                      const obf = prefix.slice(0, 5) + "*".repeat(Math.max(0, prefix.length - 5));
                                                      document.getElementById("password_reset_email_notice").innerText = `Reset password for: ${obf}@${domain}`;
                                                   }
                                             });
                                          } else {
                                             Swal.fire({ icon: "error", title: "OTP không đúng", text: data.error || "Vui lòng kiểm tra lại mã." });
                                          }
                                       } catch (err) {
                                          otpButton.disabled = false;
                                          otpButton.querySelector(".indicator-label").style.display = "inline-block";
                                          otpButton.querySelector(".indicator-progress").style.display = "none";

                                          Swal.fire({ icon: "error", title: "Lỗi máy chủ", text: "Không thể xác minh mã OTP. Vui lòng thử lại." });
                                       }
                                 });

                                 // ===== BƯỚC 3: Gửi mật khẩu mới =====
                                 btnPasswordSubmit.addEventListener("click", async function () {
                                       const password = document.getElementById("input_new_password").value;
                                       const confirmPassword = document.getElementById("input_confirm_password").value;
                                       const acceptTerms = document.getElementById("checkbox_terms").checked;

                                       if (!password || !confirmPassword) {
                                          return Swal.fire({ icon: "warning", title: "Thiếu mật khẩu", text: "Vui lòng nhập đầy đủ mật khẩu mới." });
                                       }

                                       if (password.length < 8) {
                                          return Swal.fire({ icon: "warning", title: "Mật khẩu quá ngắn", text: "Mật khẩu phải có ít nhất 8 ký tự." });
                                       }

                                       if (password !== confirmPassword) {
                                          return Swal.fire({ icon: "error", title: "Mật khẩu không khớp", text: "Vui lòng xác nhận lại mật khẩu." });
                                       }

                                       if (!acceptTerms) {
                                          return Swal.fire({ icon: "warning", title: "Chưa đồng ý điều khoản", text: "Bạn cần đồng ý điều khoản để tiếp tục." });
                                       }

                                       btnPasswordSubmit.disabled = true;
                                       btnPasswordSubmit.querySelector(".indicator-label").style.display = "none";
                                       btnPasswordSubmit.querySelector(".indicator-progress").style.display = "inline-block";

                                       try {
                                          const res = await fetch("/api/auth/forgot-password/reset", {
                                             method: "POST",
                                             headers: { "Content-Type": "application/json" },
                                             body: JSON.stringify({
                                                   email: window.currentEmail,
                                                   code: window.recoveryCode,
                                                   newPassword: password
                                             })
                                          });

                                          const data = await res.json();

                                          btnPasswordSubmit.disabled = false;
                                          btnPasswordSubmit.querySelector(".indicator-label").style.display = "inline-block";
                                          btnPasswordSubmit.querySelector(".indicator-progress").style.display = "none";

                                          if (res.ok) {
                                             Swal.fire({
                                                   icon: "success",
                                                   title: "Đổi mật khẩu thành công!",
                                                   text: "Bạn sẽ được chuyển tới trang đăng nhập.",
                                                   timer: 2000,
                                                   showConfirmButton: false
                                             }).then(() => {
                                                   window.location.href = "/auth/login";
                                             });
                                          } else {
                                             Swal.fire({ icon: "error", title: "Lỗi đổi mật khẩu", text: data.error || "Không thể đổi mật khẩu." });
                                          }
                                       } catch (err) {
                                          btnPasswordSubmit.disabled = false;
                                          btnPasswordSubmit.querySelector(".indicator-label").style.display = "inline-block";
                                          btnPasswordSubmit.querySelector(".indicator-progress").style.display = "none";

                                          Swal.fire({ icon: "error", title: "Lỗi máy chủ", text: "Không thể kết nối đến máy chủ." });
                                       }
                                 });
                              });
                           </script>

                            <!--begin::Footer-->  
                            <div class=" d-flex flex-stack">
                                <!--begin::Languages-->
                                <div class="me-10">
                                    <div class="gtranslate_wrapper"></div>
                                    <script>window.gtranslateSettings = {"default_language":"en","wrapper_selector":".gtranslate_wrapper"}</script>
                                    <script src="https://cdn.gtranslate.net/widgets/latest/float.js" defer></script>
                                </div>
                                <!--end::Languages--> 
                                <!--begin::Links-->
                                <div class="d-flex fw-semibold text-primary fs-base gap-5">
                                    <a href="https://preview.keenthemes.com/metronic8/demo38/pages/team.html" target="_blank">Terms</a>
                                    <a href="https://preview.keenthemes.com/metronic8/demo38/pages/pricing/column.html" target="_blank">Plans</a>
                                    <a href="https://preview.keenthemes.com/metronic8/demo38/pages/contact.html" target="_blank">Contact Us</a>
                                </div>
                                <!--end::Links-->
                            </div>
                            <!--end::Footer-->
                        </div>
                        <!--end::Content-->
                    </div>
                    <!--end::Wrapper-->
                </div>
                <!--end::Body-->
            </div>
            <!--end::Authentication - Sign-in-->
        </div>
        <!--end::Root--> 
        {{> scripts}}  {{!-- chỉ lấy thư viện script từ main --}}
    </body>
    <!--end::Body-->
</html>